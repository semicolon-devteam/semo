# 05-PR Workflow: Clarify & Spike

> PR 자동화에 대한 불확실성 제거 및 기술 검증

---

## Clarify (명확화 필요 사항)

### 1. PR 생성 정책

**질문**:
- 모든 Job 완료 시 자동 PR? 사용자 승인 후?
- Draft PR 사용 여부?
- PR 제목/본문 템플릿 커스터마이징 가능?

**결정 필요**:
- PR 라벨 자동 부여 규칙
- PR Reviewer 자동 할당 여부
- PR description에 포함할 정보 범위

### 2. 머지 전략

**질문**:
- Squash vs Merge commit vs Rebase?
- 역할별 머지 전략 다르게 적용?
- Merge queue에서 우선순위 조정 가능?

**결정 필요**:
- 자동 머지 조건 (CI pass? Review approval?)
- 머지 실패 시 재시도 정책
- Hotfix PR 우선 처리 여부

### 3. 의존성 머지 순서

**질문**:
- 의존성 있는 PR들 순서대로 머지 보장 방법?
- 선행 PR 머지 실패 시 후속 PR 처리?
- 병렬 머지 가능한 PR 자동 탐지?

**결정 필요**:
- Merge queue 처리 주기 (실시간? 배치?)
- 머지 대기 시간 제한
- 의존성 체인 최대 길이

### 4. Worktree 정리

**질문**:
- PR 머지 즉시 Worktree 삭제? 일정 시간 후?
- 원격 branch 삭제 정책 (즉시? 보존?)
- Worktree 정리 실패 시 처리?

**결정 필요**:
- 정리 전 백업 필요 여부
- 정리 실패 재시도 정책
- 수동 정리 트리거 제공 여부

---

## Spike (기술 검증 필요 사항)

### SPIKE-05-01: gh CLI 성능 및 안정성

**목적**: gh CLI를 통한 PR 생성/머지 성능 검증

**실험 계획**:
1. PR 생성 100회 반복 (속도, 성공률)
2. PR 머지 100회 반복
3. 동시 PR 생성 10개
4. GitHub API rate limit 측정

**성공 기준**:
- PR 생성 시간 < 3초
- PR 머지 시간 < 5초
- 성공률 > 99%
- Rate limit 충분 (시간당 5000 요청)

**예상 시간**: 1일

---

### SPIKE-05-02: 머지 충돌 자동 해결

**목적**: 자동 rebase로 해결 가능한 충돌 비율 측정

**실험 계획**:
1. 10가지 충돌 시나리오 생성
   - 같은 파일 다른 라인
   - 같은 파일 같은 라인
   - 파일 삭제/수정 충돌
2. 각 시나리오에서 자동 rebase 시도
3. 자동 해결 성공률 측정
4. 수동 해결 필요한 케이스 분류

**성공 기준**:
- 자동 해결 성공률 > 60%
- 자동 해결 시간 < 30초
- 수동 해결 안내 메시지 제공

**예상 시간**: 2일

---

### SPIKE-05-03: MergeQueue 알고리즘 검증

**목적**: 의존성 기반 머지 순서 계산 정확도 검증

**실험 계획**:
1. 복잡한 의존성 그래프 생성 (DAG)
2. 토폴로지 정렬 구현
3. 병렬 머지 가능 그룹 계산
4. 순환 의존성 감지 테스트

**성공 기준**:
- 토폴로지 정렬 정확도 100%
- 병렬 그룹 계산 < 1초
- 순환 의존성 감지율 100%

**예상 시간**: 2일

---

### SPIKE-05-04: PR 상태 동기화

**목적**: GitHub PR 상태와 Office DB 동기화 전략 검증

**실험 계획**:
1. Webhook 방식: GitHub → Office Server
2. Polling 방식: 주기적 API 호출
3. Hybrid 방식: Webhook + 주기적 검증
4. 각 방식의 지연, 신뢰성, 비용 비교

**성공 기준**:
- Webhook 지연 < 10초
- Polling 비용 적정
- 동기화 오류율 < 1%

**예상 시간**: 1일

---

## Decisions (결정 사항)

### ✅ 결정됨: PR 제목/본문 템플릿

```markdown
# PR 제목
[{role}] {job.description}

예시: [FE] 사용자 프로필 페이지 구현

# PR 본문
## Summary
{job.description}

## Changes
{변경된 파일 목록}

## Related Jobs
- Depends on: #{선행 PR 번호들}
- Blocks: #{후속 PR 번호들}

## Test Plan
{테스트 체크리스트}

---
🤖 Auto-generated by Semo Office
Agent: {agent.name} ({agent.role})
Job ID: {job.id}
```

### ✅ 결정됨: 머지 전략

- **기본 전략**: Squash and Merge
- **예외**: Hotfix는 Merge commit (히스토리 보존)
- **자동 머지 조건**:
  1. CI 통과
  2. 모든 선행 PR 머지 완료
  3. Merge conflict 없음

### ✅ 결정됨: Merge Queue 처리

```typescript
class MergeQueue {
  async processMergeQueue(officeId: string): Promise<void> {
    // 1. 머지 가능한 PR 조회 (의존성 완료, CI 통과)
    const readyPRs = await this.getReadyToMerge(officeId);

    // 2. 토폴로지 정렬 (의존성 순서)
    const orderedPRs = this.topologicalSort(readyPRs);

    // 3. 병렬 머지 그룹 계산
    const groups = this.calculateParallelGroups(orderedPRs);

    // 4. 그룹별 순차 처리
    for (const group of groups) {
      await Promise.all(group.map(pr => this.mergePR(pr)));
    }
  }
}
```

### ✅ 결정됨: Worktree 정리 시점

- **PR 머지 완료 즉시**: Worktree 삭제
- **원격 branch**: 즉시 삭제
- **로컬 branch**: Worktree와 함께 삭제
- **정리 실패 시**: 로깅 후 수동 정리 큐에 추가

---

## Open Questions (미결정 사항)

| 질문 | 담당자 | 기한 |
|------|--------|------|
| Draft PR 사용 여부 | PO | Phase 1 |
| PR Reviewer 자동 할당 | Tech Lead | Phase 3 |
| Merge queue 처리 주기 (실시간 vs 배치) | Architect | SPIKE-05-03 후 |
| Webhook vs Polling 최종 결정 | DevOps | SPIKE-05-04 후 |

---

## Risk Mitigation (리스크 완화)

### 만약 SPIKE-05-02 실패 시 (머지 충돌 자동 해결 어려움)

**대안 1**: 충돌 방지 설계
- Agent 작업 영역 명확히 분리
- 공유 파일 최소화

**대안 2**: 수동 해결 UI 제공
- Web 기반 머지 에디터
- 충돌 파일 diff 표시

**대안 3**: 충돌 시 핸드오프
- 충돌 발생 시 PO 또는 Architect에게 핸드오프
- 수동 해결 후 재머지

### 만약 SPIKE-05-01 실패 시 (gh CLI 성능 부족)

**대안**: GitHub REST API 직접 호출
- Octokit 사용
- 더 세밀한 제어 가능
- Rate limit 관리 직접 구현

---

## Next Steps

1. ✅ Clarify 문서 작성 완료
2. ⏳ SPIKE-05-01 실행 (gh CLI 검증)
3. ⏳ SPIKE-05-03 실행 (MergeQueue 알고리즘)
4. ⏳ PR 템플릿 초안 작성
5. ⏳ Open Questions 답변 수집
