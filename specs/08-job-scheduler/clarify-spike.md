# 08-Job Scheduler: Clarify & Spike

> Job 스케줄링 및 큐 관리에 대한 불확실성 제거 및 기술 검증

---

## Clarify (명확화 필요 사항)

### 1. 스케줄링 정책

**질문**:
- 스케줄링 주기: 실시간? 배치(5초)?
- Job 우선순위 동적 변경 가능?
- 긴급 Job 삽입 시 기존 Job 중단?

**결정 필요**:
- 스케줄러 워커 수 (단일? 다중?)
- Office당 독립 스케줄러? 공유 스케줄러?
- 스케줄러 장애 시 복구 전략

### 2. 의존성 해결

**질문**:
- 선행 Job 실패 시 후속 Job 처리?
- 선택적 의존성 지원 (A 또는 B 완료 후)?
- 의존성 재계산 시점?

**결정 필요**:
- 의존성 타임아웃 (선행 Job이 너무 오래 걸리면?)
- 의존성 체인 최대 깊이
- 동적 의존성 추가 가능 여부

### 3. 타임아웃 관리

**질문**:
- 역할별 타임아웃 다르게 설정?
- 타임아웃 연장 요청 가능?
- 타임아웃 임박 알림?

**결정 필요**:
- 타임아웃 계산 기준 (작업 시작 후? Job 생성 후?)
- 타임아웃 후 리소스 정리 방법
- 타임아웃 통계 수집

### 4. 재시도 정책

**질문**:
- 재시도 가능한 에러 유형 명확히 정의?
- 수동 재시도 vs 자동 재시도?
- 재시도 횟수 역할별 다르게?

**결정 필요**:
- 재시도 간격 계산 방식 (linear vs exponential)
- 재시도 실패 시 롤백 전략
- 재시도 이력 표시 방법

---

## Spike (기술 검증 필요 사항)

### SPIKE-08-01: 토폴로지 정렬 성능

**목적**: 복잡한 의존성 그래프에서 정렬 속도 측정

**실험 계획**:
1. Job 100개, 의존성 200개 그래프 생성
2. 토폴로지 정렬 실행 시간 측정
3. 병렬 실행 그룹 계산 시간 측정
4. 순환 의존성 감지 시간 측정

**성공 기준**:
- 정렬 시간 < 1초
- 병렬 그룹 계산 < 500ms
- 순환 감지 < 100ms

**예상 시간**: 1일

---

### SPIKE-08-02: 동시 실행 제한 효과

**목적**: maxConcurrentJobs 설정값에 따른 처리량 비교

**실험 계획**:
1. Job 30개 생성 (의존성 없음)
2. maxConcurrentJobs = 1, 3, 6, 10으로 테스트
3. 전체 완료 시간, 리소스 사용량 측정
4. 최적값 찾기

**성공 기준**:
- 3개: 리소스 사용량 적정, 처리 시간 합리적
- 6개 이상: 리소스 과부하 없음
- 처리량 선형 증가

**예상 시간**: 2일

---

### SPIKE-08-03: 타임아웃 정확도

**목적**: TimeoutManager의 타이머 정확도 검증

**실험 계획**:
1. 타임아웃 30초, 1분, 5분, 30분 설정
2. 각 설정으로 Job 실행
3. 실제 타임아웃 발생 시간 측정
4. 타이머 오차 계산

**성공 기준**:
- 타임아웃 오차 < 5초
- 타임아웃 처리 시간 < 1초
- 동시 타이머 100개 관리 가능

**예상 시간**: 1일

---

### SPIKE-08-04: 재시도 전략 비교

**목적**: Linear vs Exponential 백오프 효과 비교

**실험 계획**:
1. 실패율 30% 시나리오
2. Linear backoff (1분, 2분, 3분)
3. Exponential backoff (1분, 2분, 4분)
4. 전체 재시도 시간, 성공률 비교

**성공 기준**:
- Exponential이 더 빠른 복구
- 서버 부하 분산 효과
- 최종 성공률 > 95%

**예상 시간**: 1일

---

### SPIKE-08-05: 스케줄러 장애 복구

**목적**: 스케줄러 워커 크래시 시 상태 복구 검증

**실험 계획**:
1. Job 10개 실행 중 (processing)
2. 스케줄러 워커 강제 종료
3. 워커 재시작
4. 상태 복구 (DB에서 실행 중인 Job 재확인)
5. Job 재스케줄링

**성공 기준**:
- 모든 Job 손실 없음
- 중복 실행 없음
- 복구 시간 < 10초

**예상 시간**: 1일

---

## Decisions (결정 사항)

### ✅ 결정됨: 스케줄러 아키텍처

```
Office Server (Express)
    │
    │ API 호출로 Job 생성
    ↓
DB (job_queue)
    │
    │ 5초마다 폴링
    ↓
Scheduler Worker (별도 프로세스)
    ├─ DependencyResolver
    ├─ ExecutionQueue
    ├─ TimeoutManager
    └─ SchedulerLoop
          ↓
Session Executor
```

### ✅ 결정됨: 의존성 해결 규칙

```typescript
// 선행 Job 실패 시
if (依존 Job 중 하나라도 failed) {
  후속 Job → cancelled 상태
  사용자 알림: "선행 Job 실패로 취소됨"
}

// 선택적 의존성 (향후)
depends_on: {
  type: 'all' | 'any',  // 모두 완료 or 하나만 완료
  jobs: [job1, job2]
}
```

### ✅ 결정됨: 역할별 타임아웃

```typescript
const DEFAULT_TIMEOUTS = {
  PO: 15 * 60 * 1000,         // 15분
  Architect: 20 * 60 * 1000,   // 20분
  FE: 30 * 60 * 1000,          // 30분
  BE: 30 * 60 * 1000,          // 30분
  QA: 45 * 60 * 1000,          // 45분
  DevOps: 20 * 60 * 1000,      // 20분
};
```

### ✅ 결정됨: 재시도 정책

```typescript
const RETRY_POLICY = {
  maxRetries: 2,
  retryableErrors: [
    'TIMEOUT',
    'SESSION_CRASH',
    'NETWORK_ERROR',
  ],
  nonRetryableErrors: [
    'GIT_CONFLICT',
    'PERMISSION_DENIED',
    'DEPENDENCY_FAILED',
  ],
  backoff: 'exponential',
  baseDelay: 60 * 1000,  // 1분
};

// 재시도 간격
// 1차: 1분 후
// 2차: 2분 후
// 3차: 4분 후
```

---

## Open Questions (미결정 사항)

| 질문 | 담당자 | 기한 |
|------|--------|------|
| 스케줄러 다중 워커 지원 | DevOps | v0.2.0 |
| 의존성 재계산 트리거 | Architect | Phase 2 |
| 타임아웃 연장 UI 필요? | PO | Phase 6 |
| 재시도 이력 UI 표시 | UX | Phase 9 |

---

## Risk Mitigation (리스크 완화)

### 만약 SPIKE-08-01 실패 시 (토폴로지 정렬 느림)

**대안 1**: 의존성 깊이 제한
- 최대 깊이 5로 제한
- 더 단순한 그래프

**대안 2**: 캐싱
- 의존성 그래프 계산 결과 캐싱
- 변경 시만 재계산

**대안 3**: 사전 계산
- Task Decomposer에서 실행 순서 미리 계산
- Scheduler는 순서만 따름

### 만약 SPIKE-08-05 실패 시 (복구 불가능)

**대안**: 멱등성 보장
- Job 중복 실행 허용
- 각 Agent가 멱등성 보장 (같은 Job 2번 실행해도 결과 동일)

---

## Next Steps

1. ✅ Clarify 문서 작성 완료
2. ⏳ SPIKE-08-01 최우선 실행 (토폴로지 정렬)
3. ⏳ SPIKE-08-02 실행 (동시 실행 제한)
4. ⏳ SPIKE-08-05 실행 (장애 복구)
5. ⏳ 스케줄러 워커 프로세스 설계 문서 작성
6. ⏳ Open Questions 답변 수집
