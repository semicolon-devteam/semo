# SEMO Full Stack - 통합 Docker Compose
# LiteLLM + LangFuse + Redis + PostgreSQL

version: "3.9"

services:
  # ========================================
  # LiteLLM AI Gateway
  # ========================================
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: semo-litellm
    ports:
      - "4000:4000"
    environment:
      # API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # LiteLLM
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-semo-master}
      - LITELLM_DATABASE_URL=postgresql://litellm:litellm@postgres-litellm:5432/litellm

      # Redis
      - REDIS_HOST=redis

      # Slack
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}

      # LangFuse 연동
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_HOST=http://langfuse:3000

    volumes:
      - ./litellm/config.yaml:/app/config.yaml
    command: ["--config", "/app/config.yaml"]
    depends_on:
      postgres-litellm:
        condition: service_healthy
      redis:
        condition: service_started
      langfuse:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - semo-network

  litellm-ui:
    image: ghcr.io/berriai/litellm-ui:main-latest
    container_name: semo-litellm-ui
    ports:
      - "4001:3000"
    environment:
      - LITELLM_API_URL=http://litellm:4000
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-sk-semo-master}
    depends_on:
      - litellm
    restart: unless-stopped
    networks:
      - semo-network

  # ========================================
  # LangFuse Observability
  # ========================================
  langfuse:
    image: langfuse/langfuse:latest
    container_name: semo-langfuse
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://langfuse:langfuse@postgres-langfuse:5432/langfuse
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-semo-langfuse-secret}
      - SALT=${SALT:-semo-langfuse-salt}
      - TELEMETRY_ENABLED=false
    depends_on:
      postgres-langfuse:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/public/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - semo-network

  # ========================================
  # Databases
  # ========================================
  postgres-litellm:
    image: postgres:15-alpine
    container_name: semo-db-litellm
    environment:
      - POSTGRES_USER=litellm
      - POSTGRES_PASSWORD=litellm
      - POSTGRES_DB=litellm
    volumes:
      - postgres_litellm_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U litellm"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - semo-network

  postgres-langfuse:
    image: postgres:15-alpine
    container_name: semo-db-langfuse
    environment:
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=langfuse
      - POSTGRES_DB=langfuse
    volumes:
      - postgres_langfuse_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - semo-network

  # ========================================
  # Cache
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: semo-redis
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - semo-network

networks:
  semo-network:
    driver: bridge

volumes:
  postgres_litellm_data:
  postgres_langfuse_data:
  redis_data:
