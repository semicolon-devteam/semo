name: Publish semo-mcp

on:
  push:
    tags:
      - 'mcp-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 2.1.0)'
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/mcp-server

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Generate encrypted tokens
        env:
          SEMO_SLACK_BOT_TOKEN: ${{ secrets.SEMO_SLACK_BOT_TOKEN }}
          SEMO_GITHUB_APP_TOKEN: ${{ secrets.SEMO_GITHUB_APP_TOKEN }}
          SEMO_DB_PASSWORD: ${{ secrets.SEMO_DB_PASSWORD }}
        run: node scripts/generate-tokens.js

      - name: Verify tokens.generated.ts created
        run: |
          if [ ! -f src/tokens.generated.ts ]; then
            echo "β Error: src/tokens.generated.ts not found!"
            exit 1
          fi
          echo "β… src/tokens.generated.ts exists"

      - name: Build
        run: npm run build

      - name: Verify tokens.generated.js in dist
        run: |
          if [ ! -f dist/tokens.generated.js ]; then
            echo "β Error: dist/tokens.generated.js not found after build!"
            exit 1
          fi
          echo "β… dist/tokens.generated.js exists"
          npm pack --dry-run 2>&1 | grep tokens

      - name: Update version (if manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: npm version ${{ github.event.inputs.version }} --no-git-tag-version --allow-same-version

      - name: Publish to npm
        id: publish
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Job Summary (Success)
        if: success()
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "## β… semo-mcp v${VERSION} λ°°ν¬ μ„±κ³µ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### π“¦ ν¨ν‚¤μ§€ μ •λ³΄" >> $GITHUB_STEP_SUMMARY
          echo "| ν•­λ© | κ°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ν¨ν‚¤μ§€ | \`@team-semicolon/semo-mcp\` |" >> $GITHUB_STEP_SUMMARY
          echo "| λ²„μ „ | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| νΈλ¦¬κ±° | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| μ»¤λ°‹ | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### π” ν† ν° μƒνƒ" >> $GITHUB_STEP_SUMMARY
          echo "| ν† ν° | μƒνƒ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| SEMO_SLACK_BOT_TOKEN | β… μ•”νΈν™”λ¨ |" >> $GITHUB_STEP_SUMMARY
          echo "| SEMO_ENCRYPTION_KEY | β… μ„¤μ •λ¨ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### π“¥ μ„¤μΉ λ°©λ²•" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npx @team-semicolon/semo-mcp@${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### π”— λ§ν¬" >> $GITHUB_STEP_SUMMARY
          echo "- [npm ν¨ν‚¤μ§€](https://www.npmjs.com/package/@team-semicolon/semo-mcp)" >> $GITHUB_STEP_SUMMARY

      - name: Job Summary (Failure)
        if: failure()
        run: |
          VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
          echo "## β semo-mcp λ°°ν¬ μ‹¤ν¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### π“‹ μ‹¤ν¨ μ •λ³΄" >> $GITHUB_STEP_SUMMARY
          echo "| ν•­λ© | κ°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| λ²„μ „ | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| νΈλ¦¬κ±° | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| μ»¤λ°‹ | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### π” μ²΄ν¬λ¦¬μ¤νΈ" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] \`SEMO_ENCRYPTION_KEY\` μ‹ν¬λ¦Ώ μ„¤μ • ν™•μΈ (32μ)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] \`SEMO_SLACK_BOT_TOKEN\` μ‹ν¬λ¦Ώ μ„¤μ • ν™•μΈ" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] \`NPM_TOKEN\` μ‹ν¬λ¦Ώ μ„¤μ • ν™•μΈ" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] npm ν¨ν‚¤μ§€ λ²„μ „ μ¤‘λ³µ ν™•μΈ" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: semo-mcp ${{ github.ref_name }}
          body: |
            ## semo-mcp ${{ github.ref_name }}

            SEMO MCP Server μ—…λ°μ΄νΈ

            ### μ„¤μΉ/μ—…λ°μ΄νΈ
            ```bash
            npx @team-semicolon/semo-mcp@latest
            ```

            ### Changes
            - ν€ κ³µμ© ν† ν° μ•”νΈν™” λ‚΄μ¥
            - λ³΄μ• κ°•ν™”
          draft: false
          prerelease: false
